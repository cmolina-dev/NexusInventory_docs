stateDiagram-v2
    [*] --> Online: App inicia con internet
    
    state Online {
        [*] --> Sincronizado
        Sincronizado --> Sincronizando: Cambios locales detectados
        Sincronizando --> Sincronizado: Sync exitoso
        Sincronizando --> ConErrores: Falla sincronizaciÃ³n
        ConErrores --> Sincronizando: Retry automÃ¡tico
        
        note right of Sincronizado
            âœ… Base de datos local actualizada
            âœ… Puede realizar transferencias
            âœ… Reportes consolidados disponibles
        end note
    }
    
    state Offline {
        [*] --> OperacionLocal
        OperacionLocal --> ColaPendiente: Registra transacciÃ³n
        ColaPendiente --> OperacionLocal: ContinÃºa operando
        
        note right of OperacionLocal
            âœ… Ventas funcionan normalmente
            âœ… Entradas de inventario OK
            âœ… Consultas de stock OK
            âŒ NO transferencias
            âŒ NO reportes consolidados
            âŒ NO AI Normalizer
        end note
        
        note right of ColaPendiente
            ðŸ’¾ IndexedDB almacena:
            - Todas las transacciones
            - Cambios en productos
            - Ajustes de inventario
            
            ðŸ“Š UI muestra:
            "âš ï¸ 15 cambios pendientes de sync"
        end note
    }
    
    Online --> Offline: PÃ©rdida de conexiÃ³n
    Offline --> Online: ConexiÃ³n restaurada
    
    Online --> Sincronizando: Al recuperar conexiÃ³n
    
    state "SincronizaciÃ³n RecuperaciÃ³n" as SyncRecovery {
        [*] --> ValidandoCambios
        ValidandoCambios --> EnviandoCola: Cambios vÃ¡lidos
        EnviandoCola --> RecibiendoActualizaciones: Cola enviada
        RecibiendoActualizaciones --> Completado: Todo sincronizado
        
        Completado --> [*]
        
        note right of ValidandoCambios
            ðŸ” Valida timestamps
            ðŸ” Detecta conflictos
            ðŸ” Aplica polÃ­tica Last-Write-Wins
        end note
        
        note right of EnviandoCola
            ðŸ“¤ EnvÃ­a en lotes:
            1. Transacciones de inventario
            2. Cambios en productos
            3. Logs de auditorÃ­a
        end note
        
        note right of RecibiendoActualizaciones
            ðŸ“¥ Recibe del backend:
            1. Configuraciones actualizadas
            2. CatÃ¡logo maestro
            3. Notificaciones de transferencias
        end note
    }
    
    Offline --> SyncRecovery: ConexiÃ³n restaurada
    SyncRecovery --> Online: Sync completo
